<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prepaid Energy Monitor Pro</title>
    <style>
        /* Modern Professional Color Palette */
        :root {
            --primary: #0a2463;
            --secondary: #3e92cc;
            --accent: #2dc653;
            --warning: #ffb400;
            --danger: #d64045;
            --dark: #1e1f26;
            --light: #f8f9fa;
            --gray-100: #f0f2f5;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --text: #212529;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            background-color: var(--gray-100);
            color: var(--text);
            line-height: 1.6;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background-color: var(--primary);
            color: white;
            padding-top: 20px;
            position: fixed;
            height: 100vh;
            width: 240px;
            z-index: 100;
            box-shadow: var(--box-shadow);
        }

        .brand {
            display: flex;
            align-items: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .brand-name {
            font-size: 18px;
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
            padding: 20px 0;
        }

        .nav-item {
            padding: 0 15px;
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 5px;
            transition: var(--transition);
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link.active {
            background-color: var(--secondary);
            color: white;
        }

        .nav-icon {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            grid-column: 2;
            padding: 20px;
        }

        .page-header {
            padding: 15px 0;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 500;
            color: var(--dark);
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--gray-600);
            margin-top: 5px;
        }

        /* Cards & Grids */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.07);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .card-icon {
            font-size: 18px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--secondary);
            color: white;
        }

        .dashboard-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--primary);
            margin: 10px 0;
        }

        .unit {
            font-size: 16px;
            font-weight: normal;
            color: var(--gray-600);
        }

        .trend {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--gray-600);
        }

        .trend-up {
            color: var(--accent);
        }

        .trend-down {
            color: var(--danger);
        }

        /* Status Indicators */
        .status-card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .status-indicators {
            flex-grow: 1;
        }

        .status-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .status-active {
            background-color: var(--accent);
        }

        .status-inactive {
            background-color: var(--gray-500);
        }

        .status-warning {
            background-color: var(--warning);
        }

        .status-danger {
            background-color: var(--danger);
        }

        .status-label {
            font-weight: 500;
            flex-grow: 1;
        }

        .status-value {
            font-weight: 600;
        }

        .session-chip {
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--gray-300);
  background: white;
  font-size:13px;
}

.session-chip strong { font-weight: 600; }
.session-chip .badge {
  padding:3px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
  color:white;
}
.badge-active { background: var(--accent); }
.badge-upcoming { background: var(--secondary); }
.badge-ended { background: var(--gray-600); }

.session-list {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.session-row {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  padding:12px;
  border:1px solid var(--gray-200);
  border-radius:12px;
  background: var(--light);
}

.session-row .left {
  display:flex;
  flex-direction:column;
  gap:6px;
}

.session-row .right {
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
  min-width: 160px;
}

.session-row .meta {
  font-size:13px;
  color: var(--gray-700);
}

.session-row .tiny {
  font-size:12px;
  color: var(--gray-600);
}

        /* Action Areas */
        .action-card {
            height: 100%;
        }

        .action-content {
            padding-top: 10px;
        }

        .input-group {
            display: flex;
            margin-bottom: 15px;
        }

        .input-group .form-input {
            flex-grow: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .input-group .input-append {
            display: flex;
            align-items: center;
            padding: 0 12px;
            background-color: var(--gray-200);
            border: 1px solid var(--gray-300);
            border-left: none;
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
            color: var(--gray-700);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 5px;
            font-size: 14px;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(62, 146, 204, 0.1);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            border: 1px solid transparent;
            padding: 10px 16px;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 5px;
            transition: var(--transition);
        }

        .btn-primary {
            color: white;
            background-color: var(--secondary);
            border-color: var(--secondary);
        }

        .btn-primary:hover {
            background-color: #3182b8;
            border-color: #3182b8;
        }

        .btn-success {
            color: white;
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .btn-success:hover {
            background-color: #25a745;
            border-color: #25a745;
        }

        .btn-danger {
            color: white;
            background-color: var(--danger);
            border-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #c13c40;
            border-color: #c13c40;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.65;
            pointer-events: none;
        }

        /* Alerts */
        .alert {
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid transparent;
            font-size: 14px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 25px;
        }

        .settings-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-300);
        }

        .settings-icon {
            margin-right: 10px;
            color: var(--secondary);
        }

        .settings-title {
            font-size: 18px;
            font-weight: 500;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        /* Hide sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Footer */
        .dashboard-footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-300);
            color: var(--gray-600);
            font-size: 14px;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            . {
                display: none;
            }
            .main-content {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="brand">
                <div class="brand-icon">‚ö°</div>
                <div class="brand-name">EnergyPro</div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link active" onclick="showPage('dashboard')">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#account" class="nav-link" onclick="showPage('account')">
                        <span class="nav-icon">üí∞</span>
                        <span>Account</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#control" class="nav-link" onclick="showPage('control')">
                        <span class="nav-icon">üéÆ</span>
                        <span>Control</span>
                    </a>
                </li>
                <li class="nav-item">
                   <a href="#sessions" class="nav-link" onclick="showPage('sessions')">
                       <span class="nav-icon">üóìÔ∏è</span>
                       <span>Sessions</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a href="#settings" class="nav-link" onclick="showPage('settings')">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#reports" class="nav-link" onclick="showPage('reports')">
                        <span class="nav-icon">üìà</span>
                        <span>Reports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#help" class="nav-link" onclick="showPage('help')">
                        <span class="nav-icon">‚ùì</span>
                        <span>Help</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="page-section active">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Energy Dashboard</h1>
                        <p class="page-subtitle">Real-time Energy Monitoring and Control</p>
                    </div>
                    <div id="update-timestamp">Last updated: --:--:--</div>
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                 <label style="font-size:14px;color:#555;">Device:</label>
                  <select id="deviceSelect" class="form-input" style="width:160px;">
                   <option value="SOCKET001">SOCKET001</option>
                    <option value="SOCKET002">SOCKET002</option>
                     <option value="SOCKET003">SOCKET003</option>
                       <option value="SOCKET004">SOCKET004</option>
                         </select>
                </div>

                <!-- Metric Cards -->
                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">BALANCE</h3>
                            <div class="card-icon">‚Ç¶</div>
                        </div>
                        <div class="dashboard-value" id="balance">--<span class="unit">‚Ç¶</span></div>
                        <div class="trend">Available credit</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">VOLTAGE</h3>
                            <div class="card-icon">V</div>
                        </div>
                        <div class="dashboard-value" id="voltage">--<span class="unit">V</span></div>
                        <div class="trend">Line voltage</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">CURRENT</h3>
                            <div class="card-icon">A</div>
                        </div>
                        <div class="dashboard-value" id="current">--<span class="unit">A</span></div>
                        <div class="trend">Line current</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">POWER</h3>
                            <div class="card-icon">W</div>
                        </div>
                        <div class="dashboard-value" id="power">--<span class="unit">W</span></div>
                        <div class="trend">Active power</div>
                    </div>
                </div>

                <!-- Status and Control Cards -->
                <div class="card-grid">
                    <div class="card status-card">
                        <div class="card-header">
                            <h3 class="card-title">SYSTEM STATUS</h3>
                        </div>
                        <div class="status-indicators">
                            <div class="status-item">
                                <div class="status-indicator" id="power-indicator"></div>
                                <div class="status-label">Power</div>
                                <div class="status-value" id="power-status">--</div>
                            </div>
        
                            <div class="status-item">
                                <div class="status-indicator status-active"></div>
                                <div class="status-label">Total Energy</div>
                                <div class="status-value" id="energy-value">-- kWh</div>
                            </div>
                        </div>
                    </div>

                    <div class="card action-card">
                        <div class="card-header">
                            <h3 class="card-title">QUICK ACTIONS</h3>
                        </div>
                        <div class="action-content">
                            <div id="power-control-alert" style="display:none;" class="alert"></div>
                            <p style="margin-bottom:15px;">Control power supply to your premises</p>
                            <div style="display:flex;gap:10px;margin-bottom:20px;">
                                <button id="power-on-btn" class="btn btn-success" onclick="setRelay(1)" style="flex:1;" disabled>Power ON</button>
                                <button id="power-off-btn" class="btn btn-danger" onclick="setRelay(0)" style="flex:1;" disabled>Power OFF</button>
                            </div>

                            <p style="margin-bottom:15px;">Quick recharge your account</p>
                            <div class="input-group">
                                <input type="number" id="quick-recharge-amount" class="form-input" value="100" min="10" step="10">
                                <div class="input-append">‚Ç¶</div>
                            </div>
                            <button class="btn btn-primary btn-block" onclick="quickRecharge()">Recharge Now</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Section -->
            <div id="account-section" class="page-section">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Account Management</h1>
                        <p class="page-subtitle">Manage your prepaid account balance and transactions</p>
                    </div>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ACCOUNT BALANCE</h3>
                        </div>
                        <div class="dashboard-value" id="account-balance">--<span class="unit">‚Ç¶</span></div>
                        <div class="trend">Available credit</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">CONSUMPTION RATE</h3>
                        </div>
                        <div class="dashboard-value" id="consumption-rate">--<span class="unit">‚Ç¶/day</span></div>
                        <div class="trend">Average daily consumption</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">RECHARGE ACCOUNT</h3>
                    </div>
                    <div id="recharge-alert" style="display:none;" class="alert"></div>
                    <div class="form-group">
                        <label for="recharge-amount" class="form-label">Recharge Amount</label>
                        <div class="input-group">
                            <input type="number" id="recharge-amount" class="form-input" value="100" min="10" step="10">
                            <div class="input-append">‚Ç¶</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="rechargeAccount()">Process Recharge</button>
                    <button class="btn btn-danger" onclick="clearBalance()" style="margin-left:10px;">  Clear Balance</button>
                </div>
            </div>

            <!-- Control Section -->
            <div id="control-section" class="page-section">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">System Control</h1>
                        <p class="page-subtitle">Monitor and control your energy system</p>
                    </div>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">POWER CONTROL</h3>
                        </div>
                        <div id="relay-control-alert" style="display:none;" class="alert"></div>
                        <p style="margin:15px 0;">Current power status: <span id="relay-control-status">Loading...</span></p>
                        <div style="display:flex;gap:10px;">
                            <button id="control-power-on-btn" class="btn btn-success" onclick="setRelay(1)" style="flex:1;" disabled>Turn Power ON</button>
                            <button id="control-power-off-btn" class="btn btn-danger" onclick="setRelay(0)" style="flex:1;" disabled>Turn Power OFF</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">SYSTEM STATUS</h3>
                        </div>
                        <div class="status-indicators">
                            <div class="status-item">
                                <div class="status-indicator" id="control-voltage-indicator"></div>
                                <div class="status-label">Voltage Status</div>
                                <div class="status-value" id="control-voltage-status">--</div>
                            </div>
                            <div class="status-item">
                                <div class="status-indicator" id="control-current-indicator"></div>
                                <div class="status-label">Current Status</div>
                                <div class="status-value" id="control-current-status">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
<!-- Sessions Section -->
<div id="sessions-section" class="page-section">
  <div class="page-header">
    <div>
      <h1 class="page-title">Session Management</h1>
      <p class="page-subtitle">Create schedules and push them to the ESP32</p>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-primary" onclick="openSessionModal()">+ New Session</button>
      <button class="btn btn-danger" onclick="clearAllSessions()">Clear All</button>
    </div>
  </div>

  <div id="sessions-alert" style="display:none;" class="alert"></div>
    
<!-- Today's Sessions -->
<div class="card" style="margin-bottom:16px;">
  <div class="card-header" style="display:flex; align-items:center; justify-content:space-between;">
    <h3 class="card-title">TODAY'S SESSIONS</h3>
    <div style="display:flex; gap:8px; align-items:center;">
      <span id="todaySessionsMeta" style="font-size:13px; color:#6c757d;">--</span>
      <button class="btn btn-primary" onclick="renderTodaysSessions()">Refresh</button>
    </div>
  </div>

  <div id="todaySessionsWrap" style="padding-top:6px;">
    <div style="color:#6c757d;">No data yet.</div>
  </div>
</div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Saved Sessions</h3>
    </div>

    <div style="overflow:auto;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="text-align:left; border-bottom:1px solid #dee2e6;">
            <th style="padding:10px;">Device</th>
            <th style="padding:10px;">Start</th>
            <th style="padding:10px;">Duration</th>
            <th style="padding:10px;">Days</th>
            <th style="padding:10px;">Actions</th>
          </tr>
        </thead>
        <tbody id="sessionsTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="sessionModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9999; align-items:center; justify-content:center;">
    <div style="width:min(560px, 92vw); background:white; border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;"> <span id="sessionModalTitle">New Session</span> </h3>
        <button class="btn" onclick="closeSessionModal()">‚úñ</button>
      </div>

      <div class="form-group">
        <label class="form-label">Device</label>
        <select id="sessDevice" class="form-input"></select>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Start Time (HH:MM)</label>
          <input id="sessStart" class="form-input" value="06:00" placeholder="06:00" />
        </div>

        <div class="form-group">
          <label class="form-label">Duration (minutes)</label>
          <input id="sessDuration" type="number" class="form-input" value="30" min="1" step="1" />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Days</label>
        <div id="sessDaysWrap" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn" onclick="closeSessionModal()">Cancel</button>
        <button class="btn btn-success" onclick="saveSessionFromModal()">Save</button>
      </div>
    </div>
  </div>
</div>

            <!-- Settings Section -->
            <div id="settings-section" class="page-section">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">System Settings</h1>
                        <p class="page-subtitle">Configure thresholds and system parameters</p>
                    </div>
                </div>

                <div id="threshold-alert" style="display:none;" class="alert"></div>

                <form id="threshold-form">
                    <div class="card settings-section">
                        <div class="settings-header">
                            <span class="settings-icon">‚ö†Ô∏è</span>
                            <h3 class="settings-title">Safety Thresholds</h3>
                        </div>
                        
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="overVoltage" class="form-label">Over Voltage Threshold</label>
                                <div class="input-group">
                                    <input type="number" id="overVoltage" name="overVoltage" class="form-input" value="260" step="1">
                                    <div class="input-append">V</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="overCurrent" class="form-label">Over Current Threshold</label>
                                <div class="input-group">
                                    <input type="number" id="overCurrent" name="overCurrent" class="form-input" value="10.00" step="0.1">
                                    <div class="input-append">A</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card settings-section">
                        <div class="settings-header">
                            <span class="settings-icon">üîí</span>
                            <h3 class="settings-title">Security Settings</h3>
                        </div>

                    <div class="card settings-section">
                        <div class="settings-header">
                            <span class="settings-icon">üí∞</span>
                            <h3 class="settings-title">Billing Settings</h3>
                        </div>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="minBalance" class="form-label">Minimum Balance Threshold</label>
                                <div class="input-group">
                                    <input type="number" id="minBalance" name="minBalance" class="form-input" value="0.00" step="1">
                                    <div class="input-append">‚Ç¶</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="costPerKWh" class="form-label">Cost per kWh</label>
                                <div class="input-group">
                                    <input type="number" id="costPerKWh" name="costPerKWh" class="form-input" value="0.20" step="0.01">
                                    <div class="input-append">‚Ç¶</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="setThresholds()">Save All Settings</button>
                </form>

                 <!-- Factory Reset Button -->
                <div class="card settings-section">
                    <div class="settings-header">
                        <span class="settings-icon" style="color: var(--danger);">‚ö†Ô∏è</span>
                        <h3 class="settings-title" style="color: var(--danger);">Factory Reset</h3>
                    </div>
                    <p style="margin-top: 10px; margin-bottom: 20px;">Reset all settings to default and clear energy data. This action is irreversible.</p>
                    <button type="button" class="btn btn-danger" onclick="factoryReset()">Factory Reset</button>
                    <div id="factory-reset-alert" style="display:none;" class="alert"></div>
                </div>

            </div>

            <!-- Reports Section (placeholder) -->
            <div id="reports-section" class="page-section">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Reports & Analytics</h1>
                        <p class="page-subtitle">View energy consumption reports and analytics</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ENERGY CONSUMPTION</h3>
                    </div>
                    <p style="text-align:center;padding:40px 0;">Consumption reports and charts will be displayed here</p>
                </div>
            </div>

            <!-- Help Section (placeholder) -->
            <div id="help-section" class="page-section">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Help & Support</h1>
                        <p class="page-subtitle">Get help with using your prepaid energy monitor</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">SUPPORT INFORMATION</h3>
                    </div>
                    <p style="text-align:center;padding:40px 0;">Help and support information will be displayed here</p>
                </div>
            </div>

            <div class="dashboard-footer">
                <p id="update-status">Last Update: --</p>
                <p>Energy Monitor Pro ¬© 2026</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
    
       const MQTT_BROKER = 'wss://cce0028b983e49eab96dcbc4edd56661.s1.eu.hivemq.cloud:8884/mqtt';
       const MQTT_USER   = 'smartmeter';
       const MQTT_PASS   = 'Emmanuel1234$';
       const WEEKDAY_LABELS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
       const SELECTED_DEVICE_KEY = "selectedDeviceId";
        
       let selectedDeviceId = "SOCKET001";
       let lastTelemetryAt = 0;
       let offlineTimer = null;
       let sessionsStore = [];       // per selectedDeviceId
       let editingSessionId = null;  // null = create mode
        
         function topicTelemetry(id){ return `smart_socket/${id}/telemetry`; }
         function topicRelaySet(id){ return `smart_socket/${id}/relay/set`; }
         function topicRelayState(id){ return `smart_socket/${id}/relay/state`; }
         function topicRecharge(id){ return `smart_socket/${id}/balance/add`; }
         function topicBalanceSet(id){ return `smart_socket/${id}/balance/set`; }


        let relayState = false; 

        function showPage(page) {
            // Hide all page sections
            const pageSections = document.querySelectorAll('.page-section');
            pageSections.forEach(section => {
                section.classList.remove('active');
            });

            // Show selected page section
            document.getElementById(page + '-section').classList.add('active');

            // Update active nav link
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.nav-link[href="#${page}"]`).classList.add('active');

            // Update content for specific pages
            if (page === 'account') {
                const dashboardBalance = document.getElementById('balance').textContent;
                document.getElementById('account-balance').textContent = dashboardBalance;
            }
            
            if (page === "sessions") {
               loadSessionsLocal();
                 renderSessionsTable();
                   renderTodaysSessions();
            }
        }
        
        function saveSelectedDevice(id) {
          try { localStorage.setItem(SELECTED_DEVICE_KEY, id); } catch {}
        }

       function loadSelectedDevice() {
          try { return localStorage.getItem(SELECTED_DEVICE_KEY); } catch { return null; }
        }

       function applySelectedDeviceToUI(id) {
          const sel = document.getElementById("deviceSelect");
       if (!sel) return;

      // only apply if option exists
       const exists = [...sel.options].some(o => o.value === id);
       if (exists) sel.value = id;
      }
        
       function updateDashboardValues(data) {
            const bal = n(data.balance);
                const vol = n(data.voltage);
                   const cur = n(data.current);
                       const pow = n(data.power);
                            const ene = n(data.energy);

              updateElement('balance', (bal !== null ? bal.toFixed(2) : '--') + '<span class="unit">‚Ç¶</span>');
              updateElement('voltage', (vol !== null ? vol.toFixed(1) : '--') + '<span class="unit">V</span>');
              updateElement('current', (cur !== null ? cur.toFixed(3) : '--') + '<span class="unit">A</span>');
              updateElement('power',   (pow !== null ? pow.toFixed(1) : '--') + '<span class="unit">W</span>');
              updateElement('energy-value', (ene !== null ? ene.toFixed(3) : '--') + ' kWh');
}

        function handleTelemetry(data) {
           if (offlineTimer) clearTimeout(offlineTimer);
               lastTelemetryAt = Date.now();
               window.lastTelemetryTs = Date.now();
               window.latestBalanceValue = Number(data.balance ?? 0);
            
             updateDashboardValues(data);
             updateSystemStatus(data);
             updateAccountSection(data);
             updateControlSection(data);
             updatePowerControlUI(data.relayState);
             updateSettingsInputsFromTelemetry(data);

       // Fill settings inputs from device values (only if present)
         if (data.overVoltageThreshold !== undefined) {
             document.getElementById("overVoltage").value = Number(data.overVoltageThreshold);
          }
          if (data.overCurrentThreshold !== undefined) {
               document.getElementById("overCurrent").value = Number(data.overCurrentThreshold);
          }
          if (data.minimumBalance !== undefined) {
              document.getElementById("minBalance").value = Number(data.minimumBalance);
          }
         if (data.costPerKWh !== undefined) {
             document.getElementById("costPerKWh").value = Number(data.costPerKWh);
          }

                 
                    const now = new Date();
                   document.getElementById('update-timestamp').textContent = 
                  `Last updated: ${now.toLocaleTimeString()}`;
                  document.getElementById('update-status').textContent = 
                  `Last Update: ${now.toLocaleTimeString()}`;
             
     }

       // (function updateValues() {
           // fetch('/data')
              //  .then(response => response.json())
               // .then(data => {
                    // Dashboard Section Updates
                 //   updateDashboardValues(data);
                 //   updateSystemStatus(data);
                  // updatePowerControlUI(data.relayState);

                    // Account Section Updates
                //    updateAccountSection(data);

                    // Control Section Updates
               //     updateControlSection(data);

                    // Update timestamp
                 //   const now = new Date();
               //     document.getElementById('update-timestamp').textContent = `Last updated: ${now.toLocaleTimeString()}`;
                //    document.getElementById('update-status').textContent = `Last Update: ${now.toLocaleTimeString()}`;

             //   })
             //   .catch(error => {
              //      console.error('Error fetching data:', error);
              //      showAlert('Connection error. Retrying...', 'warning', 'main-alert');
              //      document.getElementById('update-status').textContent = 'Update Failed';
          //      });
       // }

        function n(v, fallback = null) {
  const x = Number(v);
  return Number.isFinite(x) ? x : fallback;
}

function updateAccountSection(data) {
  const bal = n(data.balance);
  const ene = n(data.energy);
  const cpk = n(data.costPerKWh);

  updateElement(
    'account-balance',
    (bal !== null ? bal.toFixed(2) : '--') + '<span class="unit">‚Ç¶</span>'
  );

  // If any value missing, show '--'
  let consumptionRate = '--';
  if (ene !== null && cpk !== null) {
    consumptionRate = (ene * cpk).toFixed(2);
  }

  updateElement(
    'consumption-rate',
    consumptionRate + '<span class="unit">‚Ç¶/day</span>'
  );
}

        function updateSystemStatus(data) {
            updateStatusIndicator('power-indicator', data.relayState ? 'status-active' : 'status-inactive');
            updateElement('power-status', data.relayState ? 'ON' : 'OFF');

        }

        function updatePowerControlUI(serverRelayState) {
            relayState = serverRelayState;
            const onButtonDashboard = document.getElementById('power-on-btn');
            const offButtonDashboard = document.getElementById('power-off-btn');
            const onButtonControl = document.getElementById('control-power-on-btn');
            const offButtonControl = document.getElementById('control-power-off-btn');

            if (relayState) {
                onButtonDashboard.disabled = true;
                offButtonDashboard.disabled = false;
                onButtonControl.disabled = true;
                offButtonControl.disabled = false;
            } else {
                onButtonDashboard.disabled = false;
                offButtonDashboard.disabled = true;
                onButtonControl.disabled = false;
                offButtonControl.disabled = true;
            }

            const relayStatusText = relayState ? 'ON' : 'OFF';
            updateElement('relay-control-status', relayStatusText);
        }

function resetUIForNewDevice() {
  updateElement('balance', `0.00<span class="unit">‚Ç¶</span>`);
  updateElement('voltage', `0.0<span class="unit">V</span>`);
  updateElement('current', `0.000<span class="unit">A</span>`);
  updateElement('power', `0.0<span class="unit">W</span>`);
  updateElement('energy-value', `0.000 kWh`);

  updateElement('power-status', 'OFFLINE');
  updateStatusIndicator('power-indicator', 'status-inactive');

  updateElement('relay-control-status', 'OFFLINE');

  // reset settings form to show placeholders until device sends its real settings
  document.getElementById("overVoltage").value = 260;
  document.getElementById("overCurrent").value = 10.0;
  document.getElementById("minBalance").value = 0.0;
  document.getElementById("costPerKWh").value = 0.20;

  document.getElementById('update-timestamp').textContent = `Last updated: --:--:--`;
  document.getElementById('update-status').textContent = `Last Update: --`;
}

        function startOfflineTimer() {
  if (offlineTimer) clearTimeout(offlineTimer);

  offlineTimer = setTimeout(() => {
    // If no telemetry came recently, keep zeros and mark offline
    updateElement('power-status', 'OFFLINE');
    updateStatusIndicator('power-indicator', 'status-inactive');
    updateElement('relay-control-status', 'OFFLINE');
  }, 5000); // 5 seconds
}

       function updateControlSection(data) {
  // pull numeric values safely
  const vol   = n(data.voltage);
  const cur   = n(data.current);
  const overI = n(data.overCurrentThreshold);

  // Relay status (boolean-ish)
  const relay = !!data.relayState;
  updateElement('relay-control-status', relay ? 'ON' : 'OFF');

  // Voltage status (only if voltage exists)
  const voltWarn = (vol !== null) ? (vol < 180 || vol > 250) : false;
  updateStatusIndicator('control-voltage-indicator', voltWarn ? 'status-warning' : 'status-active');
  updateElement(
    'control-voltage-status',
    (vol === null) ? '--' : (vol < 180 ? 'LOW' : (vol > 250 ? 'HIGH' : 'OK'))
  );

  // Current status (only compare if both exist)
  let curOver = false;
  if (cur !== null && overI !== null) curOver = cur > overI;

  updateStatusIndicator('control-current-indicator', curOver ? 'status-warning' : 'status-active');
  updateElement(
    'control-current-status',
    (cur === null || overI === null) ? '--' : (curOver ? 'OVER' : 'OK')
  );


  // Keep buttons in sync
  updatePowerControlUI(relay);
}

 
        function updateElement(id, html) {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = html;
            }
        }

        function updateStatusIndicator(id, className) {
            const indicator = document.getElementById(id);
            if (indicator) {
                indicator.className = 'status-indicator ' + className;
            }
        }

       function setRelay(state) {

           const onButtonDashboard = document.getElementById('power-on-btn');
           const offButtonDashboard = document.getElementById('power-off-btn');
           const onButtonControl = document.getElementById('control-power-on-btn');
           const offButtonControl = document.getElementById('control-power-off-btn');

           onButtonDashboard.disabled = true;
           offButtonDashboard.disabled = true;
           onButtonControl.disabled = true;
           offButtonControl.disabled = true;

           const alertElement = document.querySelector('.page-section.active')
           .querySelector('.alert');

           showAlert(`Processing power ${state ? 'ON' : 'OFF'}...`, 'warning', alertElement.id);

           // üëâ If MQTT is available, use it
           if (typeof mqttClient !== "undefined" && mqttClient.connected) {

           const payload = JSON.stringify({ state: state });
          mqttClient.publish(topicRelaySet(selectedDeviceId), JSON.stringify({ state: !!state }));

           setTimeout(() => {
               onButtonDashboard.disabled = false;
               offButtonDashboard.disabled = false;
               onButtonControl.disabled = false;
               offButtonControl.disabled = false;
             }, 800);

              return;
         }

    // üëâ Otherwise fallback to HTTP (your original behavior)
    fetch(`/setRelay?state=${state}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePowerControlUI(state === 1);
                showAlert(`Power turned ${state ? 'ON' : 'OFF'} successfully.`, 'success', alertElement.id);
            } else {
                showAlert('Power control failed: ' + (data.message || 'Unknown error'), 'danger', alertElement.id);
            }
        })
        .catch(err => {
            showAlert('Relay control error', 'danger', alertElement.id);
        })
        .finally(() => {
            onButtonDashboard.disabled = false;
            offButtonDashboard.disabled = false;
            onButtonControl.disabled = false;
            offButtonControl.disabled = false;
        });
}

            function rechargeAccount() {
             const amount = parseFloat(document.getElementById('recharge-amount').value);

             const rechargeButton = document.querySelector('#account-section button.btn-primary');
             rechargeButton.disabled = true;

             showAlert('Processing recharge...', 'warning', 'recharge-alert');

             // üëâ MQTT path
             if (typeof mqttClient !== "undefined" && mqttClient.connected) {
             mqttClient.publish(topicRecharge(selectedDeviceId), JSON.stringify({ amount: amount }));

             setTimeout(() => rechargeButton.disabled = false, 800);
             return;
             }

    // üëâ HTTP fallback
    fetch(`/recharge?amount=${amount}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert(`Recharge successful. New balance: ‚Ç¶${data.balance.toFixed(2)}`, 'success', 'recharge-alert');
            } else {
                showAlert('Recharge failed', 'danger', 'recharge-alert');
            }
        })
        .catch(() => showAlert('Recharge error', 'danger', 'recharge-alert'))
        .finally(() => rechargeButton.disabled = false);
}


let lastTelemetryTs = 0; // will update inside handleTelemetry()

function clearBalance() {
  if (!confirm("Clear balance to ‚Ç¶0.00?")) return;

  showAlert("Clearing balance... waiting for device confirmation", "warning", "recharge-alert");

  const beforeTs = window.lastTelemetryTs || 0;
  const start = Date.now();
  const TIMEOUT_MS = 8000;

  const isZeroish = (v) => Math.abs(Number(v || 0)) < 0.01;

  // publish clear
  mqttClient.publish(
    `smart_socket/${selectedDeviceId}/balance/set`,
    JSON.stringify({ balance: 0 })
  );

  // optimistic UI update (optional, but nice)
  // updateBalanceUI(0); // if you have a function for UI

  const timer = setInterval(() => {
    const latestBal = Number(window.latestBalanceValue ?? NaN);

    // ‚úÖ success if telemetry arrived after request AND balance is ~0
    if (window.lastTelemetryTs > beforeTs && isZeroish(latestBal)) {
      clearInterval(timer);
      showAlert("Balance cleared ‚úÖ", "success", "recharge-alert");
      return;
    }

    // ‚úÖ also count as success if UI already shows ~0 even if timestamp didn‚Äôt change
    if (isZeroish(latestBal)) {
      clearInterval(timer);
      showAlert("Balance cleared ‚úÖ", "success", "recharge-alert");
      return;
    }

    if (Date.now() - start > TIMEOUT_MS) {
      clearInterval(timer);
      showAlert("No confirmation from device. Balance may not have cleared.", "danger", "recharge-alert");
    }
  }, 200);
}

        function quickRecharge() {
    const amount = parseFloat(document.getElementById('quick-recharge-amount').value);

    const rechargeButton = document.querySelector('#dashboard-section .action-card button.btn-primary');
    rechargeButton.disabled = true;

    showAlert('Processing recharge...', 'warning', 'power-control-alert');

    // MQTT path
    if (typeof mqttClient !== "undefined" && mqttClient.connected) {
        mqttClient.publish(topicRecharge(selectedDeviceId), JSON.stringify({ amount: amount }));
        setTimeout(() => rechargeButton.disabled = false, 800);
        return;
    }

    // HTTP fallback
    fetch(`/recharge?amount=${amount}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert(`Recharge successful. New balance ‚Ç¶${data.balance.toFixed(2)}`, 'success', 'power-control-alert');
            } else {
                showAlert('Recharge failed', 'danger', 'power-control-alert');
            }
        })
        .catch(() => showAlert('Recharge error', 'danger', 'power-control-alert'))
        .finally(() => rechargeButton.disabled = false);
}


        function showAlert(message, type, alertElementId) {
            const alertDiv = document.getElementById(alertElementId);
            if(alertDiv) {
                alertDiv.textContent = message;
                alertDiv.className = `alert alert-${type}`;
                alertDiv.style.display = 'block';
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 5000);
            }
        }
function topicThresholdsSet(id){ 
  return `smart_socket/${id}/thresholds/set`; 
}

function setThresholds() {
  // ‚ùå HARD BLOCK any old fetch path
  // (If you still see /setThresholds in console after this, you're not deploying the right file.)
  console.log("‚úÖ setThresholds() called ‚Äî using MQTT only (no HTTP).");

  const data = {
    overVoltage: parseFloat(document.getElementById("overVoltage").value),
    overCurrent: parseFloat(document.getElementById("overCurrent").value),
    minBalance:  parseFloat(document.getElementById("minBalance").value),
    costPerKWh:  parseFloat(document.getElementById("costPerKWh").value),
  };

  // validate
  for (const [k,v] of Object.entries(data)) {
    if (!Number.isFinite(v)) {
      showAlert(`Invalid value for ${k}`, "danger", "threshold-alert");
      return;
    }
  }

  // ensure mqtt connected
  if (!mqttClient || !mqttClient.connected) {
    showAlert("MQTT not connected. Refresh page and try again.", "danger", "threshold-alert");
    return;
  }

  showAlert("Sending settings via MQTT...", "warning", "threshold-alert");

  const topic = topicThresholdsSet(selectedDeviceId);
  const payload = JSON.stringify(data);

  mqttClient.publish(topic, payload);

  showAlert("Settings sent ‚úÖ (waiting for device to apply)", "success", "threshold-alert");
}

        function uuid4() {
  // modern browsers
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  // fallback
  return "xxxxxxxxyxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g, c => {
    const r = (Math.random()*16)|0, v = c === "x" ? r : (r&0x3)|0x8;
    return v.toString(16);
  });
}

function sessionsKey(deviceId){ return `sessions_${deviceId}`; }

function loadSessionsLocal() {
  try {
    const raw = localStorage.getItem(sessionsKey(selectedDeviceId));
    sessionsStore = raw ? JSON.parse(raw) : [];
  } catch {
    sessionsStore = [];
  }
}

function saveSessionsLocal() {
  localStorage.setItem(sessionsKey(selectedDeviceId), JSON.stringify(sessionsStore));
}

function daysToText(days){
  return (days || [])
    .slice()
    .sort((a,b)=>a-b)
    .map(d => WEEKDAY_LABELS[d-1] || String(d))
    .join(", ");
}

function renderSessionsTable() {
  const body = document.getElementById("sessionsTableBody");
  if (!body) return;

  if (!sessionsStore.length) {
    body.innerHTML = `<tr><td colspan="5" style="padding:14px; color:#6c757d;">No sessions created yet.</td></tr>`;
    return;
  }

  body.innerHTML = sessionsStore.map(s => `
    <tr style="border-bottom:1px solid #e9ecef;">
      <td style="padding:10px;">${escapeHtml(s.deviceName || s.deviceId)}</td>
      <td style="padding:10px;">${escapeHtml(s.startTime)}</td>
      <td style="padding:10px;">${Number(s.duration)} min</td>
      <td style="padding:10px;">${escapeHtml(daysToText(s.days))}</td>
      <td style="padding:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="editSession('${s.id}')">Edit</button>
        <button class="btn btn-success" onclick="duplicateSession('${s.id}')">Duplicate +1h</button>
        <button class="btn btn-danger" onclick="deleteSession('${s.id}')">Delete</button>
      </td>
    </tr>
  `).join("");
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function openSessionModal(session=null){
  editingSessionId = session ? session.id : null;
  document.getElementById("sessionModalTitle").textContent = session ? "Edit Session" : "New Session";

  // fill devices dropdown using your existing deviceSelect options
  const devSel = document.getElementById("sessDevice");
  const source = document.getElementById("deviceSelect");
  devSel.innerHTML = "";
  [...source.options].forEach(opt => {
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.value;
    devSel.appendChild(o);
  });

  // default values
  document.getElementById("sessStart").value = session?.startTime ?? "06:00";
  document.getElementById("sessDuration").value = session?.duration ?? 30;
  devSel.value = session?.deviceId ?? selectedDeviceId;

  // days chips
  const wrap = document.getElementById("sessDaysWrap");
  wrap.innerHTML = "";
  const selected = new Set(session?.days ?? []);
  WEEKDAY_LABELS.forEach((lbl, i) => {
    const d = i+1;
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn";
    btn.textContent = lbl;
    btn.dataset.day = String(d);
    btn.style.background = selected.has(d) ? "#3e92cc" : "#e9ecef";
    btn.style.color = selected.has(d) ? "white" : "#212529";

    btn.onclick = () => {
      const day = Number(btn.dataset.day);
      if (selected.has(day)) selected.delete(day);
      else selected.add(day);

      btn.style.background = selected.has(day) ? "#3e92cc" : "#e9ecef";
      btn.style.color = selected.has(day) ? "white" : "#212529";
    };

    wrap.appendChild(btn);
  });

  // store selected days temporarily on modal
  wrap.dataset.selectedDays = JSON.stringify([...selected]);

  // keep dataset updated
  wrap.addEventListener("click", () => {
    const days = [...wrap.querySelectorAll("button")]
      .filter(b => b.style.color === "white")
      .map(b => Number(b.dataset.day));
    wrap.dataset.selectedDays = JSON.stringify(days);
  }, { once:false });

  document.getElementById("sessionModal").style.display = "flex";
}

function closeSessionModal(){
  document.getElementById("sessionModal").style.display = "none";
  editingSessionId = null;
}

function validateHHMM(s){
  // strict HH:MM 00-23 : 00-59
  const m = /^([01]\d|2[0-3]):([0-5]\d)$/.exec(String(s).trim());
  return !!m;
}

function saveSessionFromModal(){
  const devId = document.getElementById("sessDevice").value;
  const start = document.getElementById("sessStart").value.trim();
  const dur = Number(document.getElementById("sessDuration").value);
  const days = JSON.parse(document.getElementById("sessDaysWrap").dataset.selectedDays || "[]");

  if (!validateHHMM(start)) {
    showAlert("Invalid Start Time. Use HH:MM (e.g. 06:00)", "danger", "sessions-alert");
    return;
  }
  if (!Number.isFinite(dur) || dur <= 0) {
    showAlert("Invalid duration", "danger", "sessions-alert");
    return;
  }
  if (!days.length) {
    showAlert("Select at least one day", "danger", "sessions-alert");
    return;
  }

  const sessionObj = {
    id: editingSessionId || uuid4(),
    deviceId: devId,
    deviceName: devId,     // your web only has IDs; keep name same
    startTime: start,
    duration: Math.floor(dur),
    days: days.sort((a,b)=>a-b),
  };

  if (editingSessionId) {
    sessionsStore = sessionsStore.map(s => s.id === editingSessionId ? sessionObj : s);
  } else {
    sessionsStore.push(sessionObj);
  }

  saveSessionsLocal();
  renderSessionsTable();
  closeSessionModal();

  // push to ESP32
  pushSessionsToESP();
}

function editSession(id){
  const s = sessionsStore.find(x => x.id === id);
  if (!s) return;
  openSessionModal(s);
}

function deleteSession(id){
  if (!confirm("Delete this session?")) return;
  sessionsStore = sessionsStore.filter(s => s.id !== id);
  saveSessionsLocal();
  renderSessionsTable();
  pushSessionsToESP();
}

function duplicateSession(id){
  const s = sessionsStore.find(x => x.id === id);
  if (!s) return;

  // +1 hour shift like your app
  const [hh, mm] = s.startTime.split(":").map(Number);
  const newH = ((hh + 1) % 24).toString().padStart(2,"0");
  const newM = (mm).toString().padStart(2,"0");

  const dup = {
    ...s,
    id: uuid4(),
    startTime: `${newH}:${newM}`,
  };

  sessionsStore.push(dup);
  saveSessionsLocal();
  renderSessionsTable();
  pushSessionsToESP();
  showAlert("Duplicated (+1h) and pushed ‚úÖ", "success", "sessions-alert");
}

function clearAllSessions(){
  if (!confirm("Clear ALL sessions for this device?")) return;
  sessionsStore = [];
  saveSessionsLocal();
  renderSessionsTable();
  pushSessionsToESP();
}

// IMPORTANT: your ESP32 currently listens to a hardcoded topic too,
// so we publish to BOTH for compatibility.
function topicSessionsSet(id){ return `smart_socket/${id}/sessions/set`; }
function topicSessionsAck(id){ return `smart_socket/${id}/sessions/ack`; }

function pushSessionsToESP(){
  if (!mqttClient || !mqttClient.connected) {
    showAlert("MQTT not connected. Refresh and try again.", "danger", "sessions-alert");
    return;
  }

  const payload = JSON.stringify(
    sessionsStore.map(s => ({
      id: s.id,
      startTime: s.startTime,
      duration: s.duration,
      days: s.days
      // deviceId/deviceName not required by your ESP parser
    }))
  );

  showAlert("Sending sessions to device...", "warning", "sessions-alert");

  // Publish to device-specific topic
  mqttClient.publish(topicSessionsSet(selectedDeviceId), payload);

  // Also publish to your ESP's current hardcoded topic (SOCKET001)
  mqttClient.publish("smart_socket/SOCKET001/sessions/set", payload);

  // We'll mark success when we receive ACK (if your ESP publishes it).
  // If no ack comes, we still keep it saved locally.
  waitForSessionsAck();
}

let _waitingSessionsAck = false;
function waitForSessionsAck(){
  if (_waitingSessionsAck) return;
  _waitingSessionsAck = true;

  const start = Date.now();
  const TIMEOUT = 6000;

  const ackTimer = setInterval(() => {
    if (window.lastSessionsAckOk === true) {
      window.lastSessionsAckOk = false;
      clearInterval(ackTimer);
      _waitingSessionsAck = false;
      showAlert("Sessions saved & pushed to ESP32 ‚úÖ", "success", "sessions-alert");
      return;
    }

    if (Date.now() - start > TIMEOUT) {
      clearInterval(ackTimer);
      _waitingSessionsAck = false;
      // not fatal: maybe ESP didn't implement ack topic correctly
      showAlert("Sessions sent. No ACK received (still likely saved).", "warning", "sessions-alert");
    }
  }, 200);
}
        
        function updateSettingsInputsFromTelemetry(data) {
  if (data.overVoltageThreshold !== undefined)
    document.getElementById("overVoltage").value = Number(data.overVoltageThreshold);

  if (data.overCurrentThreshold !== undefined)
    document.getElementById("overCurrent").value = Number(data.overCurrentThreshold);

  if (data.minimumBalance !== undefined)
    document.getElementById("minBalance").value = Number(data.minimumBalance);

  if (data.costPerKWh !== undefined)
    document.getElementById("costPerKWh").value = Number(data.costPerKWh);
}


        function factoryReset() {
            const resetAlert = document.getElementById('factory-reset-alert');
            const resetButton = document.querySelector('#settings-section button.btn-danger');

            resetButton.disabled = true;
            showAlert('Performing factory reset...', 'warning', 'factory-reset-alert');

            fetch('/factoryReset', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Factory reset successful. System restarting...', 'success', 'factory-reset-alert');
                        setTimeout(() => {
                            window.location.href = '/login/'; // Redirect to login page after reset
                        }, 3000); // Wait 3 seconds before redirecting and restarting ESP
                    } else {
                        showAlert('Factory reset failed: ' + (data.message || 'Unknown error'), 'danger', 'factory-reset-alert');
                    }
                    resetButton.disabled = false;
                })
                .catch(error => {
                    console.error('Factory reset error:', error);
                    showAlert('Factory reset error. Please try again.', 'danger', 'factory-reset-alert');
                    resetButton.disabled = false;
                });
        }

           let mqttClient = null;
           let currentSubs = [];
           
function subscribeToDevice(id){
  if (!mqttClient || !mqttClient.connected) return;

  // unsubscribe old topics (including old ack topics)
  currentSubs.forEach(t => mqttClient.unsubscribe(t));
  currentSubs = [];

  const t1 = topicTelemetry(id);
  const t2 = topicRelayState(id);

  const ack1 = `smart_socket/${id}/sessions/ack`;
  const ack2 = `smart_socket/SOCKET001/sessions/ack`; // legacy

  const newSubs = [t1, t2, ack1, ack2];

  newSubs.forEach(t => mqttClient.subscribe(t));

  currentSubs = newSubs;

  console.log("üì° Subscribed to:", currentSubs);
}

        function parseHHMMToMinutes(hhmm){
  const [h,m] = String(hhmm).split(":").map(Number);
  if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
  return (h * 60) + m;
}

function minutesToHHMM(mins){
  const h = Math.floor(mins / 60) % 24;
  const m = mins % 60;
  return String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0");
}

function getTodayWdayNum(){
  // Your sessions use 1..7 => Mon..Sun
  const js = new Date().getDay(); // Sun=0..Sat=6
  return js === 0 ? 7 : js;       // Mon=1..Sun=7
}

function renderTodaysSessions(){
  const wrap = document.getElementById("todaySessionsWrap");
  const meta = document.getElementById("todaySessionsMeta");
  if (!wrap) return;

  // Make sure sessionsStore is loaded for the selected device
  // (you already do this on change; this is just safety)
  if (!Array.isArray(sessionsStore)) sessionsStore = [];

  const today = getTodayWdayNum();
  const now = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();

  // Filter sessions for today + selected device
  const todaySessions = sessionsStore
    .filter(s => Array.isArray(s.days) && s.days.includes(today))
    .map(s => {
      const startMin = parseHHMMToMinutes(s.startTime);
      const duration = Number(s.duration) || 0;
      const endMin = (startMin !== null) ? (startMin + duration) : null;

      const isActive = (startMin !== null && endMin !== null && nowMin >= startMin && nowMin < endMin);
      const isUpcoming = (startMin !== null && nowMin < startMin);
      const isEnded = (endMin !== null && nowMin >= endMin);

      return { ...s, startMin, endMin, isActive, isUpcoming, isEnded };
    })
    .filter(s => s.startMin !== null)
    .sort((a,b) => a.startMin - b.startMin);

  // Meta line
  const dayLabel = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][now.getDay()];
  meta.textContent = `${dayLabel} ‚Ä¢ ${todaySessions.length} session(s)`;

  if (!todaySessions.length){
    wrap.innerHTML = `<div style="color:#6c757d;">No sessions scheduled for today on <b>${selectedDeviceId}</b>.</div>`;
    return;
  }

  // Find next upcoming
  const nextUp = todaySessions.find(s => s.isUpcoming) || null;

  const chips = [];
  const activeCount = todaySessions.filter(s => s.isActive).length;
  if (activeCount) chips.push(`<span class="session-chip"><span class="badge badge-active">ACTIVE</span><strong>${activeCount}</strong> running now</span>`);
  if (nextUp) {
    chips.push(`<span class="session-chip"><span class="badge badge-upcoming">NEXT</span><strong>${nextUp.startTime}</strong> for ${nextUp.duration} min</span>`);
  }

  const chipsHtml = chips.length ? `<div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">${chips.join("")}</div>` : "";

  const rowsHtml = todaySessions.map(s => {
    const endTime = (s.endMin !== null) ? minutesToHHMM(s.endMin) : "--:--";

    let badge = `<span class="badge badge-upcoming">UPCOMING</span>`;
    if (s.isActive) badge = `<span class="badge badge-active">ACTIVE NOW</span>`;
    if (s.isEnded) badge = `<span class="badge badge-ended">ENDED</span>`;

    return `
      <div class="session-row">
        <div class="left">
          <div class="meta">
            <b>${s.startTime}</b> ‚Üí <b>${endTime}</b>
            <span style="margin-left:8px; color:#6c757d;">(${s.duration} min)</span>
          </div>
          <div class="tiny">Session ID: ${escapeHtml(s.id)}</div>
        </div>

        <div class="right">
          ${badge}
          <div class="tiny">Device: <b>${escapeHtml(s.deviceId)}</b></div>
        </div>
      </div>
    `;
  }).join("");

  wrap.innerHTML = `
    ${chipsHtml}
    <div class="session-list">${rowsHtml}</div>
  `;
}

        
function initMQTT() {
 mqttClient = mqtt.connect(MQTT_BROKER, {
  username: MQTT_USER,
  password: MQTT_PASS,

  clean: true,

  keepalive: 60,            // was 30 (increase)
  connectTimeout: 30000,    // ok
  reconnectPeriod: 5000,    // slow down reconnection
  resubscribe: true,        // ensure subs return
  protocolVersion: 4        // MQTT 3.1.1 (most stable)
});

mqttClient.on("connect", () => {
  console.log("‚úÖ MQTT connected");

  // ensure UI shows the restored selection (if any)
  const sel = document.getElementById("deviceSelect");
  if (sel) {
    applySelectedDeviceToUI(selectedDeviceId); // sets dropdown to saved device if it exists
    selectedDeviceId = sel.value;              // now selectedDeviceId matches the UI
    saveSelectedDevice(selectedDeviceId);      // re-save for consistency
  }

  subscribeToDevice(selectedDeviceId);
  startOfflineTimer();
});


  mqttClient.on("message", (topic, payload) => {
  const msg = payload.toString();
  console.log("üì© MQTT message:", topic, msg);

  let data;
  try {
    data = JSON.parse(msg);
  } catch (e) {
    console.error("‚ùå JSON parse error:", e, msg);
    return;
  }
      
if (topic.endsWith("/sessions/ack")) {
  // ESP sends {"ok":true,...}
  if (data && (data.ok === true || data.success === true)) {
    window.lastSessionsAckOk = true;
  }
  return;
}

  // ‚úÖ Handle telemetry by topic OR by deviceId inside payload
  if (topic.endsWith("/telemetry")) {
    // if payload has deviceId, use it to route correctly
    if (data.deviceId && data.deviceId !== selectedDeviceId) return;

    handleTelemetry(data);
    return;
  }

  // relay state updates
  if (topic.endsWith("/relay/state")) {
    const state = (data.state !== undefined) ? data.state : data.relayState;
    updatePowerControlUI(!!state);
    return;
  }
});


  mqttClient.on("error", err => console.error("MQTT error:", err));
  mqttClient.on("reconnect", () => console.log("üîÅ MQTT reconnecting..."));
  mqttClient.on("offline", () => console.log("üì¥ MQTT offline"));
  mqttClient.on("close", () => console.log("‚ùå socket closed"));
}
        
setInterval(() => {
  // only update if sessions page is visible
  const sec = document.getElementById("sessions-section");
  if (sec && sec.classList.contains("active")) {
    renderTodaysSessions();
  }
}, 60000); // every 60s

document.getElementById("deviceSelect").addEventListener("change", (e) => {
  selectedDeviceId = e.target.value;
  saveSelectedDevice(selectedDeviceId);   // ‚úÖ add this line

  resetUIForNewDevice();
  subscribeToDevice(selectedDeviceId);

  loadSessionsLocal();
  renderSessionsTable();
  renderTodaysSessions();

  startOfflineTimer();
});
        
// ‚úÖ Restore saved device before anything else
  const saved = loadSelectedDevice();
  if (saved) {
  selectedDeviceId = saved;
  applySelectedDeviceToUI(saved);
}


        // Initial update and set interval
       initMQTT();
       loadSessionsLocal();
       renderSessionsTable();
       renderTodaysSessions();

       //updateValues();
      // setInterval(updateValues, 3000);

        // Set initial page to dashboard
        showPage('dashboard');
    </script>
</body>
</html>
